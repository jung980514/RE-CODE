# 포팅 매뉴얼

## 목차
1. [시스템 구성](#시스템-구성)
2. [로컬 개발 환경](#로컬-개발-환경)
3. [Jenkins CI/CD](#jenkins-cicd)
4. [환경 변수](#환경-변수)
5. [트러블슈팅](#트러블슈팅)

## 보안 및 정보 보호 사항

### GitLab 소스 코드 보안
1) 사용된 JVM, 웹서버, WAS 제품 등의 중류와 설정 값, 버전(IDEA버전 포함) 기재
   - **JVM**: OpenJDK 17
   - **웹서버**: Nginx (Docker 이미지 최신 버전)
   - **WAS**: Spring Boot 내장 Tomcat
   - **Node.js**: 18+
   - **Database**: MySQL 8.0+
   - **Cache**: Redis 7+
   - **IDE**: IntelliJ IDEA (버전 무관)

2) 빌드 시 사용되는 환경 변수 등의 내용 상세 기재
   - 모든 환경 변수는 `.env` 파일로 관리
   - Jenkins Credentials를 통한 보안 변수 관리
   - 개발/운영 환경별 변수 분리

3) 배포 시 특이사항 기재
   - Docker Compose 기반 컨테이너 배포
   - SSL 인증서는 Let's Encrypt 사용
   - 외부 포트는 80/443만 노출

4) DB 접속 정보 등 프로젝트(ERD)에 활용되는 주요 계정 및 프로퍼티가 정의된 파일 목록
   - `backend/.env`: 백엔드 환경 변수 (DB, Redis, API 키 등)
   - `frontend/.env`: 프론트엔드 환경 변수
   - `docker-compose.yml`: 컨테이너 설정 및 네트워크 구성

### 외부 서비스 정보
소셜 인증, 포트 클라우드, 코드 컴파일 등에 활용된 '외부 서비스' 기입 및 활용에 필요한 정보:

**사용된 외부 서비스:**
- **카카오 로그인**: 소셜 인증 서비스
  - 필요 정보: `KAKAO_CLIENT_ID`, `NEXT_PUBLIC_KAKAO_REDIRECT_URI`
  - 설정: 카카오 개발자 콘솔에서 앱 등록 및 리다이렉트 URI 설정

- **CLOVA API**: 네이버 AI 서비스 
  - 필요 정보: `CLOVA_DOMAIN_CODE`, `CLOVA_DOMAIN_ID`, `CLOVA_SECRET_KEY`
  - 설정: 네이버 클라우드 플랫폼 콘솔에서 API 키 발급

- **Google Maps API**: 지도 서비스
  - 필요 정보: `GMS_API_KEY`
  - 설정: Google Cloud Console에서 Maps API 활성화 및 키 발급

- **Google TTS API**: 텍스트 음성 변환 서비스
  - 필요 정보: `GOOGLE_TTS_API_KEY`
  - 설정: Google Cloud Console에서 TTS API 활성화 및 키 발급

- **AWS 서비스**: 클라우드 스토리지 등
  - 필요 정보: `AWS_ACCESS_KEY`, `AWS_SECRET_KEY`
  - 설정: AWS IAM에서 액세스 키 발급

- **Docker Hub**: 컨테이너 이미지 저장소
  - 필요 정보: Docker Hub 계정 (Jenkins에서 사용)
  - 설정: Docker Hub 계정 생성 및 리포지토리 생성

**주의사항:**
- 모든 외부 서비스 키는 Jenkins Credentials에 Secret text로 저장
- 개발/운영 환경별로 별도의 API 키 사용 권장
- API 사용량 제한 및 과금 정책 확인 필요

---

## 시스템 구성

### 아키텍처
```
Nginx (80/443, 외부노출 단일 진입) → Frontend (3030, 내부)
                                 → Backend (8088, 내부 /api 연결)
                                  ↓
                          MySQL (3306, 내부) + Redis (6379, 내부)
                                  ↓
                          Prometheus (9090, 내부) + Grafana (3000, 내부/LB 뒤)
```

**원칙**: 외부에 노출되는 포트는 80/443(Nginx)만. DB/Redis/모니터링 포트는 외부 미노출.

### 통합 환경 구성
- **로컬**: localhost (개발자 PC)
- **서버**: 실제 도메인 (EC2 - 개발/운영 통합)

---

## 로컬 개발 환경

### 사전 요구사항
- Docker 20.10+, Docker Compose v2+
- Node.js 18+, Java 17+

---

## EC2 서버 배포

### EC2 설정
- **사양**: Ubuntu 22.04 LTS
- **보안그룹**: 80, 443, 22만 허용

### 단계 
1. 도메인 설정
2. 방화벽 설정
3. SSL 인증서 준비
4. 시스템 업데이트 및 필수 패키지 설치
5. Docker 설치

## Jenkins CI/CD

### Jenkins Credentials 설정

**등록 위치**: Jenkins 관리 → Credentials (System → Global credentials)

**등록 예시** (도커 hub로그인 정보를 제외하고는 Secret text 타입):

| Credentials ID | 타입 | 설명 |
|---|---|---|
| `REDIS_HOST` | Secret text | Redis 호스트 (일반적으로 'redis') |
| `REDIS_PASSWORD` | Secret text | Redis 인증 비밀번호 |
| `AWS_ACCESS_KEY` | Secret text | AWS 액세스 키 |
| `AWS_SECRET_KEY` | Secret text | AWS 시크릿 키 |
| `CLOVA_DOMAIN_CODE` | Secret text | CLOVA API 도메인 코드 |
| `CLOVA_DOMAIN_ID` | Secret text | CLOVA API 도메인 ID |
| `CLOVA_SECRET_KEY` | Secret text | CLOVA API 시크릿 키 |
| `GMS_API_KEY` | Secret text | Google Maps API 키 |
| `JWT_SECRET` | Secret text | JWT 토큰 서명 키 |
| `KAKAO_CLIENT_ID` | Secret text | 카카오 API 클라이언트 ID |
| `DB_IP` | Secret text | 데이터베이스 IP |
| `DB_NAME` | Secret text | 데이터베이스 이름 |
| `DB_USERNAME` | Secret text | 데이터베이스 사용자명 |
| `DB_PASSWORD` | Secret text | 데이터베이스 비밀번호 |
| `GRAFANA_USER` | Secret text | Grafana 관리자 사용자명 |
| `GRAFANA_PW` | Secret text | Grafana 관리자 비밀번호 |
| `DATA_SOURCE_NAME` | Secret text | MySQL 데이터소스 연결 문자열 |
| `GOOGLE_TTS_API_KEY` | Secret text | Google TTS API 키 |
| `NEXT_PUBLIC_BACKEND_URL` | Secret text | 프론트엔드용 백엔드 URL |
| `NEXT_PUBLIC_KAKAO_CLIENT_ID` | Secret text | 프론트엔드용 카카오 클라이언트 ID |
| `NEXT_PUBLIC_KAKAO_REDIRECT_URI` | Secret text | 카카오 로그인 리다이렉트 URI |
| `dockerhub-credentials` | Username with password | Docker Hub 로그인 정보 |

> **주의사항**:
> - ID는 **문서와 파이프라인에서 동일 철자**로 사용합니다.
> - Docker Hub Credentials는 Username with password 타입을 사용합니다.


## 환경 변수

### 백엔드 환경 변수 (backend/.env)
```env
# Spring Profile
SPRING_PROFILES_ACTIVE=dev  # 로컬: dev, 서버: prod

# 데이터베이스
DB_IP=localhost
DB_USERNAME=app_user
DB_PASSWORD=secure_password
DB_NAME=app_db

# Redis
REDIS_HOST=localhost  # Docker 환경에서는 redis
REDIS_PASSWORD=redis_password

# JWT
JWT_SECRET=your_jwt_secret

# AWS
AWS_ACCESS_KEY=your_access_key
AWS_SECRET_KEY=your_secret_key

# 외부 API
CLOVA_DOMAIN_CODE=clova_code
CLOVA_DOMAIN_ID=clova_id  
CLOVA_SECRET_KEY=clova_key
GMS_API_KEY=google_maps_key
KAKAO_CLIENT_ID=kakao_client_id
GOOGLE_TTS_API_KEY=google_tts_key

# Grafana 설정
GRAFANA_USER=admin
GRAFANA_PW=admin

# MySQL 모니터링용 데이터소스
DATA_SOURCE_NAME=user:password@(mysql:3306)/database
```

### 프론트엔드 환경 변수 (frontend/.env)
```env
# 백엔드 URL (슬래시 중복 방지 - 끝에 / 금지)
NEXT_PUBLIC_BACKEND_URL=http://localhost:8088  # 로컬
NEXT_PUBLIC_BACKEND_URL=https://your-domain.com/api  # 서버

# 카카오 API
NEXT_PUBLIC_KAKAO_CLIENT_ID=kakao_client_id
NEXT_PUBLIC_KAKAO_REDIRECT_URI=http://localhost:3030/auth/callback  # 로컬
NEXT_PUBLIC_KAKAO_REDIRECT_URI=https://your-domain.com/auth/callback  # 서버

# Google TTS API
GOOGLE_TTS_API_KEY=google_tts_key
```

### 환경 파일 구조
```
프로젝트루트/
├── docker-compose.yml
├── backend/
│   └── .env
└── frontend/
    └── .env.local
```

### 보안 지침
- 환경 파일 권한: `chmod 600 backend/.env frontend/.env`
- 내부 포트만 사용 (3306, 6379 등 외부 차단)
- 정기적인 패키지 업데이트
- 컨테이너 비루트 사용자 실행

---

## 트러블슈팅

### 자주 발생하는 문제

#### 1. 컨테이너 시작 실패
```bash
# 로그 확인
docker compose logs [서비스명]

# 포트 충돌 확인
sudo netstat -tulpn | grep [포트]

# 메모리 확인
free -h
docker system prune -f
```

#### 2. 네트워크 연결 문제
```bash
# 컨테이너 간 통신 확인
docker compose exec backend nslookup redis
docker compose exec backend nc -zv redis 6379

# 환경 변수 확인
docker compose exec backend env | grep REDIS_
docker compose exec backend env | grep DB_
```

#### 3. SSL/HTTPS 문제
```bash
# 인증서 확인
sudo ls -la /etc/letsencrypt/live/your-domain.com/

# 인증서 갱신
sudo certbot renew

# Nginx 설정 테스트
docker compose exec nginx nginx -t
```

#### 4. 환경 변수 미적용
```bash
# 백엔드 환경 변수 확인
ls -la backend/.env
cat backend/.env

# 프론트엔드 환경 변수 확인  
ls -la frontend/.env
cat frontend/.env

# 빌드 args 전달 확인 (프론트엔드)
docker compose config | grep NEXT_PUBLIC

# Next.js 빌드 시점 환경 변수 확인
docker compose exec frontend printenv | grep NEXT_PUBLIC
```

#### 5. Redis 연결 실패
```bash
# Redis 연결 테스트
docker compose exec redis redis-cli -a ${REDIS_PASSWORD} ping

# Backend에서 Redis 연결 확인
docker compose exec backend env | grep REDIS_
```

#### 6. Jenkins 배포 관련 문제
```bash
# Credentials 바인딩 확인 (보안상 실제 값 출력 금지)
# 환경 파일 생성 확인
ls -la backend/.env frontend/.env
stat backend/.env  # 권한 확인 (600이어야 함)

# 빌드 시점 환경 변수 확인 (Next.js)
docker compose logs frontend | grep "NEXT_PUBLIC"
```

#### 7. 모니터링 서비스 문제
```bash
# Prometheus 상태 확인
curl -f http://localhost:9090/-/healthy

# Grafana 상태 확인  
curl -f http://localhost:3000/api/health

# MySQL Exporter 확인
curl -f http://localhost:9104/metrics

# Redis Exporter 확인
curl -f http://localhost:9121/metrics
```

### 유용한 명령어
```bash
# 전체 재시작 (고아 컨테이너 제거)
docker compose down --remove-orphans
docker compose up -d --build

# 컨테이너 접속
docker compose exec [서비스명] /bin/bash

# 리소스 모니터링
docker stats

# 로그 실시간 확인
docker compose logs -f [서비스명]

# 이미지 정리
docker image prune -f
docker system prune -f

# 특정 서비스만 재시작
docker compose restart [서비스명]
```

### 백업
```bash
# MySQL 백업
docker compose exec mysql mysqldump -u root -p${DB_PASSWORD} ${DB_NAME} > backup.sql

# Redis 백업
docker compose exec redis redis-cli -a ${REDIS_PASSWORD} SAVE
docker cp $(docker compose ps -q redis):/data/dump.rdb ./backup/

# Grafana 대시보드 백업
docker cp $(docker compose ps -q grafana):/var/lib/grafana ./backup/grafana-data

# 설정 파일 백업
tar -czf config_backup.tar.gz docker-compose.yml backend/.env frontend/.env nginx/
```

### 성능 최적화
- **메모리 설정**: JVM 힙 사이즈 조정
- **커넥션 풀**: 데이터베이스 연결 수 조정  
- **Nginx 캐싱**: 정적 파일 캐시 설정
- **이미지 최적화**: 멀티스테이지 빌드 활용

### CI/CD 보안 모범 사례
- **비밀 노출 방지**: `set +x` 사용, 로그에 민감 정보 출력 금지
- **파일 권한**: 환경 파일은 `chmod 600`으로 설정
- **Credentials 범위**: Global보다는 필요한 Job/Pipeline 범위로 제한
- **정기 갱신**: JWT 시크릿, DB 비밀번호 등 정기적 갱신

### 빌드/배포 명령 주의사항
- **Next.js**: `NEXT_PUBLIC_*` 환경 변수는 **빌드 이전**에 반드시 설정
- **URL 슬래시**: `NEXT_PUBLIC_BACKEND_URL`은 끝에 `/` 금지
- **컨테이너 정리**: `--remove-orphans` 옵션으로 고아 컨테이너 제거
- **이미지 갱신**: `--build` 옵션으로 이미지 강제 재빌드
- **Redis 호스트**: Docker 환경에서는 `REDIS_HOST=redis` (서비스명) 사용